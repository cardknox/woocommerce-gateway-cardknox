jQuery(function(e){"use strict";function r(r,o,n,c,t,a){let i={action:"get_data",xKey:wc_cardknox_params.xkey,xRefNum:c,xCavv:o,xEci:n,x3dsAuthenticationStatus:t,x3dsSignatureVerificationStatus:a,x3dsActionCode:r,x3dsError:ck3DS.error,xVersion:wc_cardknox_params.xVersion,xSoftwareName:wc_cardknox_params.xSoftwareName,xSoftwareVersion:wc_cardknox_params.xSoftwareVersion,xAllowDuplicate:1};e.ajax({type:"post",dataType:"json",url:wc_cardknox_params.threeds_object.ajax_url,data:i,success:function(r){("E"==r.xResult||"D"==r.xResult)&&(e(".woocommerce-error, .woocommerce-message").remove(),e("form.checkout").prev(".woocommerce-notices-wrapper").append('<ul class="woocommerce-error" role="alert"><li>'+r.xError+"</li></ul>")),"A"==r.xResult&&(window.location.href=r.redirect)}})}function o(e){return JSON.parse('{"'+decodeURI(e).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}')}e("form.checkout, form#order_review").on("change",'input[name="wc-cardknox-payment-token"]',function(){"new"===e('.cardknox-legacy-payment-fields input[name="wc-cardknox-payment-token"]:checked').val()?e(".cardknox-legacy-payment-fields #cardknox-payment-data").slideDown(200):e(".cardknox-legacy-payment-fields #cardknox-payment-data").slideUp(200)}),window.onload=function(){"yes"==wc_cardknox_params.enable_3ds?enable3DS(wc_cardknox_params.threeds_env,r):enable3DS(wc_cardknox_params.threeds_env,null)};var n={init:function(){this.onIfieldloaded(),e("form.woocommerce-checkout").length&&(this.form=e("form.woocommerce-checkout")),e("form.woocommerce-checkout").on("checkout_place_order_cardknox",this.onSubmit).on("change",this.reset),e("form#order_review").length&&(this.form=e("form#order_review")),e("form#order_review").on("submit",this.onSubmit),e("form#add_payment_method").length&&(this.form=e("form#add_payment_method")),e("form#add_payment_method").on("submit",this.onSubmit),e(document).on("change","#wc-cardknox-cc-form :input",this.reset).on("cardknoxError",this.onError).on("checkout_error",this.reset)},isCardknoxChosen:function(){return e("#payment_method_cardknox").is(":checked")&&(!e('input[name="wc-cardknox-payment-token"]:checked').length||"new"===e('input[name="wc-cardknox-payment-token"]:checked').val())},hasExp:function(){return 0<e("input.xExp").length},block:function(){n.form.block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){n.form.unblock()},onError:function(r,o){console.log("onError"),e(".wc-cardknox-error, .xExp").remove(),e("#ifieldsError").closest("p").before('<ul class="woocommerce_error woocommerce-error wc-cardknox-error"><li>'+o+"</li></ul>");let c=jQuery("input#cardknox-card-number").val(),t=jQuery("input#cardknox-card-cvc").val(),a=document.getElementById("cardknox-card-expiry");""!==c&&""!==t&&(a&&""!==a.value.trim()?e(a).css("border","1px solid #c3c3c3"):(e(a).css("border","1px solid red"),e("#ifieldsError").text("Expiry Date is required."))),n.unblock()},onSubmit:function(){return!n.isCardknoxChosen()||!!n.hasExp()||(n.block(),getTokens(function(){return""===document.getElementsByName("xCardNum")[0].value?(e(document).trigger("cardknoxError","Card Number Required"),setIfieldStyle("card-number",{border:"1px solid red"}),!1):(setIfieldStyle("card-number",{border:"1px solid #c3c3c3"}),""===document.getElementsByName("xCVV")[0].value)?(e(document).trigger("cardknoxError","CVV Required"),setIfieldStyle("cvv",{border:"1px solid red"}),!1):(setIfieldStyle("cvv",{border:"1px solid #c3c3c3"}),void(n.onCardknoxResponse(),jQuery(document.body).trigger("update_checkout")))},function(){return console.log("error"),e(document).trigger("cardknoxError",document.getElementById("ifieldsError").textContent),!1},2e4),!1)},onCardknoxResponse:function(){var r=document.getElementById("cardknox-card-expiry").value.replace(/\s|\//g,"");if(4!=r.length)return e(document).trigger("cardknoxError","Invalid expiration date"),!1;let o=parseInt(r.substr(0,2)),c=parseInt(r.substr(2)),t=new Date,a=t.getFullYear()%100,i=t.getMonth()+1;if(c<a||c===a&&o<i)return e(document).trigger("cardknoxError","Expiration must be in the future"),!1;n.form.append("<input type='hidden' class='xExp' id='xExp' name='xExp' value='"+r+"'/>"),e.ajax({type:"POST",url:"?wc-ajax=checkout",data:e("form.woocommerce-checkout").serialize(),beforeSend:function(){},success:function(r){if("success"===r.result){let o=r.response;"V"==o.xResult&&o.xVerifyPayload&&""!==o.xVerifyPayload&&o.xVerifyURL&&""!==o.xVerifyURL&&verify3DS(o),"A"==o.xResult&&(window.location.href=r.redirect)}else e("form.woocommerce-checkout .blockUI.blockOverlay").hide(),e(".woocommerce-error, .woocommerce-message").remove(),n.form.prepend(r.messages);e("form.woocommerce-checkout .blockUI.blockOverlay").hide()},error:function(r,o,n){console.log("Error placing order:",o,n),e("form.woocommerce-checkout .blockUI.blockOverlay").hide()},complete:function(){e("form.woocommerce-checkout .blockUI.blockOverlay").hide()}})},reset:function(){e("#cardknox-card-cvc, #cardknox-card-number").val(""),e(".xExp").remove()},onIfieldloaded:function(){enableLogging(),setAccount(wc_cardknox_params.key,"wordpress","0.1.2");var r={outline:"none",border:"1px solid #c3c3c3","border-radius":"4px",padding:"0.6180469716em",width:"93%",height:"30px","background-color":wc_cardknox_params.bgcolor,"font-weight":"inherit","background-image":"url("+e(".payment_method_cardknox label").find("img").attr("src")+")","background-size":"32%","background-repeat":"no-repeat","background-position":"right 10px center"},o={outline:"none",border:"1px solid #c3c3c3","border-radius":"4px",padding:"0.6180469716em",width:"85%",height:"30px","background-color":wc_cardknox_params.bgcolor,"font-weight":"inherit"};function n(){window.matchMedia("(max-width: 767px)").matches?(r.width="100%",r.height="48px",o.width="100%",o.height="48px",r["box-sizing"]="border-box",o["box-sizing"]="border-box"):(r.width="93%",o.width="85%"),setIfieldStyle("card-number",r),setIfieldStyle("cvv",o)}n(),window.addEventListener("resize",n),enableAutoFormatting(),addIfieldCallback("input",function(e){e.ifieldValueChanged&&(setIfieldStyle("card-number",e.cardNumberFormattedLength<=0?defaultStyle:e.cardNumberIsValid?validStyle:invalidStyle),"cvv"===e.lastIfieldChanged?setIfieldStyle("cvv","unknown"===e.issuer||e.cvvLength<=0?defaultStyle:e.cvvIsValid?validStyle:invalidStyle):"card-number"===e.lastIfieldChanged?"unknown"===e.issuer||e.cvvLength<=0?setIfieldStyle("cvv",defaultStyle):"amex"===e.issuer?setIfieldStyle("cvv",4===e.cvvLength?validStyle:invalidStyle):setIfieldStyle("cvv",3===e.cvvLength?validStyle:invalidStyle):"ach"===e.lastIfieldChanged&&setIfieldStyle("ach",0===e.achLength?defaultStyle:e.achIsValid?validStyle:invalidStyle))}),addIfieldCallback("issuerupdated",function(e){setIfieldStyle("cvv","unknown"===e.issuer||e.cvvLength<=0?defaultStyle:e.cvvIsValid?validStyle:invalidStyle)})}};n.init()}),jQuery(document).ready(function(){jQuery(document.body).on("updated_checkout",function(){jQuery("#ap-container").hide();var e='input[name="payment_method"]',r='button[name="woocommerce_checkout_place_order"]';function o(){var o=jQuery(e+":checked").val();"cardknox-applepay"===o?(jQuery(r).hide(),jQuery("div#divGpay").hide(),jQuery("#ap-container").show(),jQuery(".applepay-error").show()):"cardknox-googlepay"===o?(jQuery(r).hide(),jQuery("div#divGpay").show(),jQuery("#ap-container").hide(),jQuery(".applepay-error").hide()):(jQuery(r).show(),jQuery("div#divGpay").hide(),jQuery("#ap-container").hide(),jQuery(".applepay-error").hide())}o(),jQuery(document).on("change",e,function(){o()})})});